# FitRepair

In FitRepair, we introduce 3 different strategies for patch generation
- **Knowledge-Intensified fine-tuning**
- **Repair-Oriented fine-tuning**
- **Relevant-Identifier prompting**

We combine the patches generated by all 3 strategies together with the base-model (codet5-large) to fix a bug.

For the fine-tuning models, you can find them in `models/` parts of the repository. For Relevant-Identifier prompting, we use the base codet5-large model.

Below we describe how you can generate patches using each of our 3 strategies

### Generate patches

We support two dataset `defects4j-1.2` and `defects4j-2.0`

#### base model:
```shell
python repair.py --dataset=defects4j-1.2-full \
                 --folder=folder_path_for_saving_patches \
                 --batch_size=256
```

#### Knowledge-Intensified fine-tuning
```shell
python repair.py --model_name=model/knowledge-intensified-model
                 --dataset=defects4j-1.2-full \
                 --project_identifier=Chart \
                 --folder=folder_path_for_saving_patches \
                 --batch_size=256
```

#### Repair-Oriented fine-tuning
```shell
python repair.py --model_name=model/repair-oriented-model
                 --dataset=defects4j-1.2-full \
                 --project_identifier=Chart \
                 --folder=folder_path_for_saving_patches \
                 --batch_size=256
```

Note that for both fine-tuned models, we train a separate model for each project so to generate the patches for one project you may want to pick the appropriately trained model


#### Relevant-Identifier prompting
```shell
python repair.py --dataset=defects4j-1.2-full \
                 --instruction \
                 --folder=folder_path_for_saving_patches \
                 --batch_size=256
```

### Fine-tuning

#### Building Dataset

E.g. for Defects4j:
```shell
arr=( "Chart" "Closure" "Lang" "Math" "Mockito" "Time" )
for identifier in "${arr[@]}"
do
python extract_project_function.py --project_identifier=$identifier \
                                   --bug_id=oldest \
                                   --language=java \
                                   --data_path=$DATAPATH \
                                   --dataset_name=defects4j \
                                   --extract_type=function_with_bug
done
```

#### Fine-tuning Model
```shell
deepspeed --include localhost:0 --master_port 6000 finetune.py  --masking_rate=80 \
                                                                --masking_style=6 \
                                                                --batch_size=32 \
                                                                --micro_batch_size=8 \
                                                                --num_gpus=1 \
                                                                --lr=1e-4 \
                                                                --static_repeat=1 \
                                                                --name=test_function_with_bug_1500 \
                                                                --fp16 \
                                                                --seed=420 \
                                                                --dataset_name=defects4j \
                                                                --extract_type=function_with_bug \
                                                                --repo_name=jfreechart \
                                                                --bug_id=$id \
                                                                --max_steps=1500 \
                                                                --data_path=$DATAPATH
```
